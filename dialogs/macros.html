<!DOCTYPE html>
<html lang="en">
<head>
    <title>Macros</title>
    <style>
        .macro-container {
            min-height: 200px;
            height: 50vh;
            overflow-y: scroll;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 50px;
            border-radius: 15px;
            padding: 2px;
        }

        .macro-item {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
        }

        .macro-item:hover {
            background: var(--background-color-2);
        }

        .macro-icon {
            font-family: "Material Symbols Rounded";
            font-size: 48px;
            text-align: center;
            opacity: 0.9;
            margin-bottom: 6px;
            user-select: none;
        }

        .macro-title {
            font-weight: bold;
            text-align: center;
        }

        .macro-desc {
            opacity: .6;
            font-size: 12px;
            text-align: center;
        }

        .macro-empty-state {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color, #555);
            text-align: center;
            padding: 20px;
        }

        /* small spacing fix for form dialog */
        .prompt-dialog label {
            margin-top: 10px;
            display: block;
            font-size: 14px;
            opacity: .8;
        }

        .prompt-dialog input {
            width: 100%;
            margin-top: 4px;
            margin-bottom: 6px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div id="macro-container" class="macro-container"></div>

    <script>
        async function promptMacroInfo(macro = {}) {
            return new Promise((resolve) => {
                const overlay = document.createElement("div");
                overlay.className = "prompt-overlay";

                const dialog = document.createElement("div");
                dialog.className = "prompt-dialog";
                dialog.style.padding = "20px";

                const title = document.createElement("p");
                title.className = "prompt-title";
                title.textContent = (macro.name ? "Edit macro" : "New macro");
                dialog.appendChild(title);

                const nameLabel = document.createElement("label");
                nameLabel.textContent = "Name";
                const nameInput = document.createElement("input");
                nameInput.type = "text";
                nameInput.value = macro.name || "";
                dialog.appendChild(nameLabel);
                dialog.appendChild(nameInput);

                const descLabel = document.createElement("label");
                descLabel.textContent = "Description";
                const descInput = document.createElement("input");
                descInput.type = "text";
                descInput.value = macro.description || "";
                dialog.appendChild(descLabel);
                dialog.appendChild(descInput);

                const iconLabel = document.createElement("label");
                iconLabel.textContent = "Icon (Material Symbols)";
                const iconInput = document.createElement("input");
                iconInput.type = "text";
                iconInput.value = macro.icon || "action_key";
                dialog.appendChild(iconLabel);
                dialog.appendChild(iconInput);

                const buttonContainer = document.createElement("div");
                buttonContainer.className = "prompt-buttons";

                const cancelButton = document.createElement("button");
                cancelButton.textContent = "Cancel";
                cancelButton.className = "prompt-button cancel";

                const submitButton = document.createElement("button");
                submitButton.textContent = "Save";
                submitButton.className = "prompt-button submit";

                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(submitButton);
                dialog.appendChild(buttonContainer);

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                function close(result) {
                    document.body.removeChild(overlay);
                    resolve(result);
                }

                cancelButton.onclick = () => close(null);
                submitButton.onclick = () =>
                    close({
                        name: nameInput.value,
                        description: descInput.value,
                        icon: iconInput.value
                    });

                overlay.addEventListener("keydown", (ev) => {
                    if (ev.key === "Escape") close(null);
                    if (ev.key === "Enter") close({
                        name: nameInput.value,
                        description: descInput.value,
                        icon: iconInput.value
                    });
                });

                nameInput.focus();
            });
        }

        async function renderMacros() {
            const container = document.getElementById("macro-container");
            container.innerHTML = "";

            const list = await Macros.getAll();

            if (!list.length) {
                container.innerHTML = `<div class="macro-empty-state">
                    <img src="cohesion/file-icons/floppy.svg" alt="No files" class="empty-icon">
                    <h2>Nothing here</h2>
                    <p>Create macros to trigger automation directly through slash-commands.</p></div>`;
                return;
            }

            list.forEach((macro, index) => {
                const div = document.createElement("div");
                div.className = "macro-item";
                div.innerHTML = `
                    <div class="macro-icon">${macro.icon || "action_key"}</div>
                    <div>
                        <div class="macro-title">${macro.name}</div>
                        <div class="macro-desc">${macro.description || ""}</div>
                    </div>

                    <div class="dropdown" style="position:absolute; top:8px; right:8px;">
                        <button class="icon-button" onclick="toggleDropdown('mac${index}')">more_vert</button>
                        <div class="menu dropdown-content" id="mac${index}">
                            <button class="text-button" onclick="editMacroCode(${index})">Edit</button>
                            <hr>
                            <button class="text-button" onclick="editMacroInfo(${index})">Properties</button>
                            <button class="text-button" onclick="runMacro(${index})">Run</button>
                            <hr>
                            <button class="text-button danger" onclick="deleteMacro(${index})">Delete</button>
                        </div>
                    </div>
                `;
                div.addEventListener('dblclick', () => {
                    editMacroCode(index);
                });
                container.appendChild(div);
            });
        }

        async function createMacro() {
            const info = await promptMacroInfo({});
            if (!info) return;

            const code = await promptCodeEditor("");

            await Macros.create({
                name: info.name,
                description: info.description,
                icon: info.icon,
                code
            });

            renderMacros();
        }

        async function runMacro(index) {
            const macro = await Macros.get(index);
            const fn = new Function(macro.code);
            await fn();
        }

        async function deleteMacro(index) {
            await Macros.delete(index);
            renderMacros();
        }

        async function editMacroInfo(index) {
            const macro = await Macros.get(index);
            const result = await promptMacroInfo(macro);
            if (!result) return;

            await Macros.update(index, result);
            renderMacros();
        }

        async function editMacroCode(index) {
            const macro = await Macros.get(index);

            const code = await promptCodeEditor(macro.code || "");

            if (code === null) return;

            await Macros.update(index, { code });
            renderMacros();
        }

        renderMacros();
    </script>
</body>
</html>
