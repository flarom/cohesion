<!DOCTYPE html>
<html lang="en">
<head>
    <title>Macros</title>

    <meta name="dialog-show-close-button" content="true">
    <meta name="dialog-prefered-width" content="800">
    <meta name="dialog-toolbar-left" content="<button class='icon-button' onclick='createMacro()' translate='no' title='Create macro' data-locale-attr='title:dialog.macros.header.create-macro'>add</button>
                <button class='icon-button' onclick='importMacro()' translate='no' title='Import macro' data-locale-attr='title:dialog.macros.header.import-macro'>folder_open</button>">
    <meta name="<div class='dropdown'>
                    <button class='icon-button' onmousedown='toggleDropdown(`macros-more-menu`)' translate='no' title='More options' data-locale-attr='title:generic.more-menu'>more_vert</button>
                    <div class='dropdown-content menu' id='macros-more-menu'>
                        <button class='text-button' onclick='window.open(`https://github.com/flarom/cohesion/wiki/Scripting`)' data-locale='dialog.macros.header.about-scripting'>About scripting</button>
                    </div>
                </div>">

    <style>
        .macro-container {
            min-height: 200px;
            height: 50vh;
            overflow-y: scroll;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 50px;
            border-radius: 15px;
            padding: 2px;
            transition: all .3s;
            border: 2px dashed transparent;
        }

        .macro-item {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            align-items: center;
        }

        .macro-item:hover {
            background: var(--background-color-2);
        }

        .macro-icon {
            font-family: "Material Symbols Rounded";
            font-size: 48px;
            text-align: center;
            opacity: 0.9;
            margin-bottom: 6px;
            user-select: none;
            max-width: 1ch;
            overflow: hidden;
        }

        .macro-title {
            font-weight: bold;
            text-align: center;
        }

        .macro-desc {
            opacity: .6;
            font-size: 12px;
            text-align: center;
        }

        .macro-empty-state {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color, #555);
            text-align: center;
            padding: 20px;
        }

        .macro-drag-over {
            background-color: var(--selection-color);
            margin: 50px 10px 10px 10px;
            border: 2px dashed var(--highlight-color);
        }

        /* small spacing fix for form dialog */
        .prompt-dialog label {
            margin-top: 10px;
            display: block;
            font-size: 14px;
            opacity: .8;
        }

        .prompt-dialog input {
            width: 100%;
            margin-top: 4px;
            margin-bottom: 6px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div id="macro-container" class="macro-container"></div>

    <script>
        async function renderMacros() {
            const container = document.getElementById("macro-container");
            container.innerHTML = "";

            const list = await Macros.getAll();

            if (!list.length) {
                container.innerHTML = `<div class="macro-empty-state">
                    <img src="cohesion/file-icons/floppy.svg" alt="No files" class="empty-icon">
                    <h2 data-locale="dialog.macros.empty-title">Nothing here</h2>
                    <p data-locale="dialog.macros.empty-description">Create macros to trigger automation directly through slash-commands.</p></div>`;
                return;
            }

            list.forEach((macro, index) => {
                const div = document.createElement("div");
                div.className = "macro-item";
                div.title = macro.description;
                div.innerHTML = `
                    <div class="macro-icon" translate="no">${macro.icon || "action_key"}</div>
                    <div>
                        <div class="macro-title" translate="no">${macro.name}</div>
                        <div class="macro-desc" data-locale="dialog.macros.macro.author" data-locale-vars='${JSON.stringify({author: macro.author || ""})}'>by ${macro.author || ""}</div>
                    </div>

                    <div class="dropdown" style="position:absolute; top:8px; right:8px;">
                        <button class="icon-button" translate="no" onclick="toggleDropdown('mac${index}')">more_vert</button>
                        <div class="menu dropdown-content" id="mac${index}">
                            <button class="text-button" onclick="editMacroCode(${index})" data-locale="dialog.macros.macro.edit-code">Edit code</button>
                            <button class="text-button" onclick="editMacroInfo(${index})" data-locale="dialog.macros.macro.properties">Properties</button>
                            <hr>
                            <button class="text-button" onclick="Macros.export(${index});" data-locale="dialog.macros.macro.download">Download</button>
                            <button class="text-button" onclick="runMacro(${index})" data-locale="dialog.macros.macro.run">Run</button>
                            <hr>
                            <button class="text-button danger" onclick="deleteMacro(${index})" data-locale="dialog.macros.macro.delete">Delete</button>
                        </div>
                    </div>
                `;
                div.addEventListener('dblclick', () => {
                    editMacroCode(index);
                });
                container.appendChild(div);
            });
        }

        (function allowDragDrop() {
            const container = document.getElementById("macro-container");

            ["dragenter", "dragover", "dragleave", "drop"].forEach(evName => {
                container.addEventListener(evName, (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                });
            });

            container.addEventListener("dragenter", () => {
                container.classList.add("macro-drag-over");
            });

            container.addEventListener("dragover", () => {
                container.classList.add("macro-drag-over");
            });

            container.addEventListener("dragleave", (ev) => {
                if (!container.contains(ev.relatedTarget)) {
                    container.classList.remove("macro-drag-over");
                }
            });

            container.addEventListener("drop", async (ev) => {
                container.classList.remove("macro-drag-over");

                const file = ev.dataTransfer.files[0];
                if (!file) return;

                const text = await file.text();

                const macro = await Macros.import(text);
                if (macro) renderMacros();
            });
        })();

        async function createMacro() {
            const info = await promptMacroInfo({});
            if (!info) return;

            const code = await promptCodeEditor("");

            await Macros.create({
                name: info.name,
                author: info.author,
                description: info.description,
                icon: info.icon,
                code
            });

            renderMacros();
        }

        async function runMacro(index) {
            const macro = await Macros.get(index);
            const fn = new Function(macro.code);
            await fn();
        }

        async function deleteMacro(index) {
            await Macros.delete(index);
            renderMacros();
        }

        async function editMacroInfo(index) {
            const macro = await Macros.get(index);
            const result = await promptMacroInfo(macro);
            if (!result) return;

            await Macros.update(index, result);
            renderMacros();
        }

        async function editMacroCode(index) {
            const macro = await Macros.get(index);

            const code = await promptCodeEditor(macro.code || "");

            if (code === null) return;

            await Macros.update(index, { code });
            renderMacros();
        }

        async function importMacro() {
            const text = await Macros.pickFile();
            if (!text) return;

            const macro = await Macros.import(text);
            if (macro) renderMacros();
        }

        renderMacros();
    </script>
</body>
</html>
