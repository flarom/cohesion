<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>New document</title>
        <link rel="shortcut icon" href="cohesion/favicon.png" type="image/x-icon" />

        <meta content="website" property="og:type" />

        <meta content="Cohesion Markdown Text Editor" name="title" />
        <meta content="Cohesion Markdown Text Editor" property="og:title" />
        <meta content="Cohesion is a free and opensource online markdown text editor" name="description" />
        <meta content="Cohesion is a free and opensource online markdown text editor" property="og:description" />

        <meta content="Cohesion, markdown, text, editor, free, opensource" name="keywords" />
        <meta content="https://flarom.github.io/cohesion/cohesion/scrshot.png" property="og:image" />
        <meta content="https://flarom.github.io/cohesion" property="og:url" />
        <meta content="index, follow" name="robots" />

        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta content="#303030" name="theme-color" />
        <link rel="manifest" href="/manifest.json" />

        <link rel="stylesheet" href="style/palette.css" />
        <link rel="stylesheet" href="style/share.css" />
        <link rel="stylesheet" href="style/editor.css" />
        <link rel="stylesheet" href="style/prompts.css" />
        <link rel="stylesheet" href="script/codemirror/lib/codemirror.css" />
        <link rel="stylesheet" href="script/codemirror/addon/hint/show-hint.css" />
        <link rel="stylesheet" href="script/highlight/lib/highlight.css">
        
        <script src="script/codemirror/lib/codemirror.js"></script>
        <script src="script/codemirror/keymap/sublime.js"></script>
        <script src="script/codemirror/overlay/markOverlay.js"></script>
        <script src="script/codemirror/overlay/entityOverlay.js"></script>
        <script src="script/codemirror/overlay/underlineOverlay.js"></script>
        <script src="script/codemirror/addon/edit/closebrackets.js"></script>
        <script src="script/codemirror/addon/edit/continuelist.js"></script>
        <script src="script/codemirror/addon/search/searchcursor.js"></script>
        <script src="script/codemirror/addon/hint/show-hint.js"></script>
        <script src="script/codemirror/addon/hint/anyword-hint.js"></script>
        <script src="script/codemirror/addon/hint/emoji-hint.js"></script>
        <script src="script/codemirror/addon/hint/command-hint.js"></script>
        <script src="script/codemirror/addon/selection/active-line.js"></script>
        <script src="script/codemirror/addon/mode/simple.js"></script>

        <script src="script/codemirror/mode/meta.js"></script>
        <script src="script/codemirror/mode/plain/plain.js"></script>
        <script src="script/codemirror/mode/markdown/markdown.js"></script>
        <script src="script/codemirror/mode/javascript/javascript.js"></script>
        <script src="script/codemirror/mode/css/css.js"></script>
        <script src="script/codemirror/mode/clike/clike.js"></script>
        <script src="script/codemirror/mode/diff/diff.js"></script>
        <script src="script/codemirror/mode/php/php.js"></script>
        <script src="script/codemirror/mode/properties/properties.js"></script>
        <script src="script/codemirror/mode/python/python.js"></script>
        <script src="script/codemirror/mode/rust/rust.js"></script>
        <script src="script/codemirror/mode/shell/shell.js"></script>
        <script src="script/codemirror/mode/sql/sql.js"></script>
        <script src="script/codemirror/mode/toml/toml.js"></script>
        <script src="script/codemirror/mode/xml/xml.js"></script>
        <script src="script/codemirror/mode/yaml/yaml.js"></script>
    </head>

    <body class="theme-dark">
        <header class="window-title bottom" id="main-header">
            <div class="header-left">
                <button class="icon-button" translate="no" onmousedown="toggleSidebar('files-bar')" ondragenter="toggleSidebar('files-bar')" title="Documents">side_navigation</button>
                <button class="icon-button hide-on-mobile" translate="no" title="New document" onclick="createFile(); togglePreview('editor');">add_box</button>
                <hr class="hide-on-mobile" />
                <button class="icon-button hide-on-mobile" translate="no" title="Un-do" onclick="editor.undo();">undo</button>
                <button class="icon-button hide-on-mobile" translate="no" title="Re-do" onclick="editor.redo();">redo</button>
                <hr />
                <div class="dropdown">
                    <button class="icon-button" translate="no" onmousedown="toggleDropdown('insert-menu')" title="Insert">attach_filearrow_drop_down</button>
                    <div class="dropdown-content menu align-left" id="insert-menu">
                        <button class="text-button" onmouseup="insertDate(); hideAllMenus(); editor.focus()">Date and time <kbd>F6</kbd></button>
                        <hr>
                        <button class="text-button" onmouseup="handleInsertImage(); hideAllMenus(); editor.focus();">Image</button>
                        <button class="text-button" onmouseup="handleInsertAudio(); hideAllMenus(); editor.focus();">Audio</button>
                        <button class="text-button" onmouseup="handleInsertVideo(); hideAllMenus(); editor.focus();">Video</button>
                        <hr />
                        <button class="text-button" onmouseup="handleInsertBlock(); hideAllMenus();">Block</button>
                        <button class="text-button" onmouseup="promptTableSelector().then((markdown) => {if (markdown) {insertBlock(markdown);}}); hideAllMenus()">Table</button>
                        <button class="text-button" onmouseup="insertBlock(getSummary(editor.getValue())); hideAllMenus()">Summary</button>
                        <button class="text-button" onmouseup="insertAtTop(getMeta()); hideAllMenus();">
                            Document meta
                            <kbd>Ctrl+;</kbd>
                        </button>
                        <hr />
                        <button class="text-button" onmouseup="promptIframe().then((markdown) => {if (markdown) {insertBlock(markdown);}}); hideAllMenus()">Web embed</button>
                    </div>
                </div>
            </div>
            <div class="header-center hide-on-tablet">
                <p id="filename">title</p>
            </div>
            <div class="header-right">
                <button class="icon-button" translate="no" onclick="toggleSearchHeader();" title="Search" id="search-btn">search</button>
                <button class="icon-button" translate="no" onclick="togglePreview()" title="Read" id="readbtn">import_contacts</button>
                <div class="dropdown">
                    <button class="icon-button" translate="no" onmousedown="toggleDropdown('more-menu')" title="More options">more_vert</button>
                    <div class="dropdown-content menu" id="more-menu">
                        <button class="text-button" onmouseup="createFile(); hideAllMenus()">
                            New
                            <kbd>Ctrl+N</kbd>
                        </button>
                        <button class="text-button" onmouseup="importFile(); hideAllMenus()">
                            Open
                            <kbd>Ctrl+O</kbd>
                        </button>
                        <button class="text-button" onmouseup="promptSaveFile(index); hideAllMenus()">
                            Save
                            <kbd>Ctrl+S</kbd>
                        </button>
                        <hr>
                        <button class="text-button" onmouseup="searchDocuments(); hideAllMenus();">
                            Search documents
                            <kbd>Ctrl+E</kbd>
                        </button>
                        <hr />
                        <button class="text-button" onmouseup="showMessageFromFile('dialogs/resources.html', true, true); hideAllMenus()">
                            Resources
                            <kbd>Alt+P</kbd>
                        </button>
                        <button class="text-button" onmouseup="showMessageFromFile('dialogs/settings.html', true, false, true, true, 900); hideAllMenus()">
                            Settings
                            <kbd>Ctrl+,</kbd>
                        </button>
                        <hr />
                        <button class="text-button" onmouseup="showMessageFromFile('landing.html', false, true, false, false);">Learn</button>
                        <button class="text-button" onmouseup="showMessageFromFile('dialogs/shortcuts.html', true, false, true, true, 600); hideAllMenus();">
                            Keyboard shortcuts
                            <kbd>Ctrl+?</kbd>
                        </button>
                        <button class="text-button" onmouseup="showMessageFromFile('about.html'); hideAllMenus();">
                            About Cohesion
                            <kbd>F1</kbd>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div id="files-bar" class="sidebar">
            <button class="text-button hide-on-pc" style="width: 100%; margin-top: 20px; margin-bottom: 20px" onclick="createFile();">Create new document</button>
            <div id="files"></div>
        </div>

        <div class="main-wrapper">
            <header class="window-title off bottom" id="search-header">
                <div class="header-center" style="display: flex; align-items: center; gap: 0px">
                    <div class="field-container">
                        <label class="icon" for="search-field" translate="no">search</label>
                        <input type="text" name="search-field" id="search-field" />
                    </div>
                    <button id="search-prev-btn" class="icon-button button-group-member" title="Previous" translate="no">keyboard_arrow_up</button>
                    <button id="search-next-btn" class="icon-button button-group-member right" title="Next" translate="no">keyboard_arrow_down</button>
                    <button id="match-case-btn" class="icon-button button-group-member left" title="Match casing" translate="no">match_case</button>
                    <button id="regex-btn" class="icon-button button-group-member" title="Regular expression" translate="no">regular_expression</button>
                    <button class="icon-button button-group-member right" translate="no" title="Replace" onclick="toggleReplaceHeader()" id="replace-btn">find_replace</button>
                </div>
            </header>
            <header class="window-title off bottom" id="replace-header">
                <div class="header-center" style="display: flex; align-items: center; gap: 0px">
                    <div class="field-container" style="border-radius: 5px; margin-right: 3.5px">
                        <label class="icon" for="replace-field" translate="no">find_replace</label>
                        <input type="text" name="replace-field" id="replace-field" />
                    </div>
                    <button id="replace-one-btn" class="text-button button-group-member left">Replace</button>
                    <button id="replace-all-btn" class="text-button button-group-member right">Rep. all</button>
                </div>
            </header>
            <textarea id="editor" class="editor"></textarea>
            <div id="preview" class="preview"></div>
            <div class="status-bar" id="status">
                <div class="status-bar-left">
                    <div class="status-bar-item">
                        <label id="cursorPosLabel">Ln 0, Col 0</label>
                    </div>
                    <div class="status-bar-item">
                        <label id="editorMode">
                            <span class="icon">edit</span>
                            <span>Edit mode</span>
                        </label>
                    </div>
                </div>
                <div class="status-bar-right">
                    <div class="status-bar-item">
                        <label id="documentSizeLabel">0 Characters, 0 Words</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="editorMenu" class="context-menu">
            <div style="display: flex; margin: 0px 5px">
                <button class="icon-button" translate="no" title="Bold" onmouseup="formatBold()">format_bold</button>
                <button class="icon-button" translate="no" title="Italic" onmouseup="formatItalic()">format_italic</button>
                <button class="icon-button" translate="no" title="Underline" onmouseup="formatUnderline()">format_underlined</button>
                <button class="icon-button" translate="no" title="Strikethrough" onmouseup="formatStrikethrough()">strikethrough_s</button>
                <button class="icon-button" translate="no" title="Preformatted" onmouseup="formatPreformatted()">code</button>
                <button class="icon-button" translate="no" title="Highlight" onmouseup="formatHighlight()">stylus_highlighter</button>
                <button class="icon-button" translate="no" title="Link" onmouseup="formatUrl()">link</button>
            </div>
            <hr id="contextual-selection-separator" style="display: none" />
            <button class="text-button" onmouseup="formatTable(); editor.focus()" id="formatTable" style="display: none">Format table</button>
            <button class="text-button" onmouseup="window.open(editor.getSelection()); editor.focus()" id="openSelectedURL" style="display: none">Open URL</button>
            <hr />
            <button class="text-button" onmouseup="cutText()">
                Cut
                <kbd>Ctrl+X</kbd>
            </button>
            <button class="text-button" onmouseup="copyText()">
                Copy
                <kbd>Ctrl+C</kbd>
            </button>
            <button class="text-button" onmouseup="pasteText()">
                Paste
                <kbd>Ctrl+V</kbd>
            </button>
            <button class="text-button" onmouseup="deleteText()">
                Delete
                <kbd>Delete</kbd>
            </button>
            <hr />
            <button class="text-button" onmouseup="editor.undo()">
                Un-do
                <kbd>Ctrl+Z</kbd>
            </button>
            <button class="text-button" onmouseup="editor.redo()">
                Re-do
                <kbd>Ctrl+Y</kbd>
            </button>
            <hr />
            <button class="text-button" onmouseup="selectAllText()">
                Select all
                <kbd>Ctrl+A</kbd>
            </button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="script/highlight/lib/highlight.min.js"></script>
        <script src="script/html2pdf.bundle.min.js"></script>
        <script src="script/resources.js"></script>
        <script src="script/showdown/lib/showdown.js"></script>
        <script src="script/showdown/extension/bannerImage.js"></script>
        <script src="script/showdown/extension/internalLink.js"></script>
        <script src="script/showdown/extension/definitionList.js"></script>
        <script src="script/showdown/extension/abbreviation.js"></script>
        <script src="script/showdown/extension/rubyText.js"></script>
        <script src="script/editorTools.js"></script>
        <script src="script/insert.js"></script>
        <script src="script/prompts.js"></script>
        <script src="script/file.js"></script>
        <script src="script/edit.js"></script>
        <script src="script/settings.js"></script>
        <script>
            window.addEventListener("storage", (event) => {
                if (event.key === "markdownFiles") {
                    location.reload();
                }
            });

            loadFilesFromStorage();

            let index = localStorage.getItem("lastIndex") || 0;

            const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
                mode: "markdown",
                lineNumbers: getSetting("editorLineNumbers", false) === "true",
                theme: "default",
                lineWrapping: true,
                autoCloseBrackets: getSetting("editorAutoCloseBrackets", "true") === "true" ,
                autoCloseTags: getSetting("editorAutoCloseTags", "false") === "true" ,
                extraKeys: {
                    Enter: "newlineAndIndentContinueMarkdownList",
                    "Ctrl-Space": "autocomplete",
                },
                keyMap: "sublime",
                direction: getSetting("editorDirection", "ltr"),
                showCursorWhenSelecting: true,
                styleActiveLine: getSetting("editorHighlightActiveLine", "true") === "true",
            });

            editor.addOverlay(markOverlay);
            editor.addOverlay(htmlEntityOverlay);
            editor.addOverlay(underlineOverlay);

            const editorMenu = document.getElementById("editorMenu");
            const hrContextualSeparator = document.getElementById("contextual-selection-separator");
            const btnFormatTable = document.getElementById("formatTable");
            const btnOpenURL = document.getElementById("openSelectedURL");

            editor.getWrapperElement().addEventListener("contextmenu", function (e) {
                e.preventDefault();

                if (hasTableSelected()) {
                    hrContextualSeparator.style.display = "block";
                    btnFormatTable.style.display = "flex";
                } else {
                    hrContextualSeparator.style.display = "none";
                    btnFormatTable.style.display = "none";
                }

                if (hasURLSelected()) {
                    hrContextualSeparator.style.display = "block";
                    btnOpenURL.style.display = "flex";
                } else {
                    hrContextualSeparator.style.display = "none";
                    btnOpenURL.style.display = "none";
                }

                const rect = editor.getWrapperElement().getBoundingClientRect();
                editorMenu.style.top = e.clientY + "px";
                editorMenu.style.left = e.clientX + "px";
                editorMenu.style.display = "block";

                const buttons = editorMenu.querySelectorAll("button");
                if (buttons.length > 0) {
                    setTimeout(() => buttons[0].focus(), 0);
                }
                editorMenu.addEventListener("keydown", handleArrowNavigation);
                editorMenu.addEventListener("keydown", handleActivation);
            });

            editor.getWrapperElement().addEventListener("paste", async function (e) {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.kind === "file") {
                        const file = item.getAsFile();
                        if (file) {
                            try {
                                const savedFile = await saveClipboardFile(file);
                                const filePath = `resources/${savedFile.name}`;

                                const ext = savedFile.name.split(".").pop().toLowerCase();

                                let markdown = `![ALT TEXT](${filePath})`;

                                insertAt(markdown, 2, 10);
                                showToast(`Archieved ${savedFile.name}`, "archive");
                            } catch (err) {
                                showToast("Failed to insert clipboard file.", "error");
                                console.error(err);
                            }
                        }
                    }
                }
            });

            document.addEventListener("click", function () {
                editorMenu.style.display = "none";
                editorMenu.removeEventListener("keydown", handleArrowNavigation);
                editorMenu.removeEventListener("keydown", handleActivation);
            });

            const converter = new showdown.Converter({
                extensions: ['bannerImage', 'internalLink', 'definitionList', 'abbreviation', 'rubyText'],
            });

            const preview = document.getElementById("preview");

            const statusBar = document.getElementById("status");
            const cursorPosLabel = document.getElementById("cursorPosLabel");
            const documentSizeLabel = document.getElementById("documentSizeLabel");
            const editorModeLabel = document.getElementById("editorMode");

            const searchField = document.getElementById("search-field");
            const replaceField = document.getElementById("replace-field");
            let lastQuery = "";
            let caseSensitive = false;
            let useRegex = false;
            let currentCursor = null;

            function renderEditor() {
                if (!files[index]) files[index] = "";
                editor.setValue(files[index]);
                document.getElementById("filename").innerText = getFileTitle(index) || "New document";
                document.title = getFileTitle(index) || "New document - Cohesion";
            }

            const urlParams = new URLSearchParams(window.location.search);
            const introParam = urlParams.get('intro');
            if (
                files.length < 1 ||
                (introParam === 'true') ||
                (introParam === null && files.length < 1)
            ) {
                if (introParam !== 'false') {
                    showMessageFromFile('landing.html', false, true, false, false);

                    const landingKeyHandler = (event) => {
                        if (/^[a-zA-Z0-9]$/.test(event.key)) {
                            fadeOutAllDialogs();
                            editor.focus();
                            document.removeEventListener("keydown", landingKeyHandler);
                        }
                    };

                    document.addEventListener("keydown", landingKeyHandler);
                }
            }

            try {
            renderFiles("files");
            } catch (err) {
                promptMessage(`
                    <h1>That's bad...</h1>
                    <p>Something went wrong while loading the application, and it cannot run safely.</p>
                `, false);
            }
            renderEditor();
            editor.focus();
            document.addEventListener("DOMContentLoaded", () => {
                loadSettings();
            });

            let debounceTimer;

            editor.on("change", (instance) => {
                const cursor = instance.getCursor();
                const content = instance.getValue();

                cursorPosLabel.textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;

                const charCount = content.length;
                const wordCount = content.trim().split(/\s+/).filter(Boolean).length;
                documentSizeLabel.textContent = `${charCount} Characters, ${wordCount} Words`;

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updateFile(content, index);
                    saveFilesToStorage();
                    renderFiles("files");
                    document.getElementById("filename").innerText = getFileTitle(index) || "New document";
                    document.title = getFileTitle(index) || "New document - Cohesion";
                    if (preview.classList.contains("on")) {
                        updateMarkdown(content);
                    }
                }, 100);
            });

            editor.on("inputRead", function (cm, change) {
                if (getSetting("editorShowHints", "true") === "false") return;

                var cursor = cm.getCursor();
                var token = cm.getTokenAt(cursor);
                var line = cm.getLine(cursor.line);
                var beforeCursor = line.slice(0, cursor.ch);

                var match = beforeCursor.match(/\/[\w\-]*$/);
                if (match) {
                    cm.showHint({
                        hint: CodeMirror.hint.command,
                        completeSingle: false,
                    });
                    return;
                }

                var emojiMatch = beforeCursor.match(/:[\w+\-_]*:?$/);
                if (emojiMatch) {
                    cm.showHint({
                        hint: CodeMirror.hint.emoji,
                        completeSingle: false,
                    });
                    return;
                }

                if (!change.text[0].match(/\w/)) return;

                var currentWord = token.string;

                if (currentWord.length >= 2) {
                    cm.showHint({
                        hint: function(cm) {
                            var anyword = CodeMirror.hint.anyword(cm) || {from: cm.getCursor(), to: cm.getCursor(), list: []};
                            var emoji = CodeMirror.hint.emoji(cm) || {from: cm.getCursor(), to: cm.getCursor(), list: []};

                            var list = [...new Set([...anyword.list, ...emoji.list])];
                            return {
                                from: anyword.from,
                                to: anyword.to,
                                list: list
                            };
                        },
                        completeSingle: false,
                    });
                }
            });

            function togglePreview(forceMode) {
                const isOn = preview.classList.contains("on");
                const readBtn = document.getElementById("readbtn");

                const shouldShowPreview = forceMode === "preview" || (forceMode !== "editor" && !isOn);

                if (shouldShowPreview) {
                    updateMarkdown(editor.getValue());

                    const cursorLine = editor.getCursor().line;
                    const totalLines = editor.lineCount();
                    const scrollRatio = cursorLine / totalLines;

                    preview.classList.add("on");
                    setTimeout(()=>{ preview.focus(); }, 1);
                    editor.getWrapperElement().style.display = "none";
                    readBtn.innerText = "edit";
                    readBtn.title = "Write";
                    readBtn.classList.add("button-on");
                    editorModeLabel.innerHTML = "<span class='icon'>import_contacts</span><span>Read mode</span>";

                    requestAnimationFrame(() => {
                        preview.scrollTop = scrollRatio * (preview.scrollHeight - preview.clientHeight);
                    });
                } else {
                    preview.classList.remove("on");
                    editor.getWrapperElement().style.display = "block";
                    editor.focus();
                    readBtn.innerText = "import_contacts";
                    readBtn.title = "Read";
                    readBtn.classList.remove("button-on");

                    editorModeLabel.innerHTML = "<span class='icon'>edit</span><span>Edit mode</span>";
                }
            }

            function toggleSearchHeader(text = "", force = null) {
                const mainHeader = document.getElementById("main-header");
                const searchHeader = document.getElementById("search-header");
                const replaceHeader = document.getElementById("replace-header");
                const searchBtn = document.getElementById("search-btn");
                const replaceBtn = document.getElementById("replace-btn");

                const isCurrentlyOff = searchHeader.classList.contains("off");
                const shouldOpen = force === null ? isCurrentlyOff : force;

                if (shouldOpen) {
                    mainHeader.classList.remove("bottom");
                    searchHeader.classList.add("bottom");
                    replaceHeader.classList.remove("bottom");

                    searchHeader.classList.remove("off");
                    replaceHeader.classList.add("off");

                    searchBtn.classList.add("button-on");
                    replaceBtn.classList.remove("button-on");

                    searchField.focus();
                    searchField.value = text;
                } else {
                    mainHeader.classList.add("bottom");
                    searchHeader.classList.remove("bottom");
                    replaceHeader.classList.remove("bottom");

                    searchHeader.classList.add("off");
                    replaceHeader.classList.add("off");

                    searchBtn.classList.remove("button-on");
                    replaceBtn.classList.remove("button-on");
                }
            }

            function toggleReplaceHeader(text = "", force = null) {
                const mainHeader = document.getElementById("main-header");
                const searchHeader = document.getElementById("search-header");
                const replaceHeader = document.getElementById("replace-header");
                const searchBtn = document.getElementById("search-btn");
                const replaceBtn = document.getElementById("replace-btn");

                const isCurrentlyOff = replaceHeader.classList.contains("off");
                const shouldOpen = force === null ? isCurrentlyOff : force;

                if (shouldOpen) {
                    mainHeader.classList.remove("bottom");
                    searchHeader.classList.remove("bottom");
                    replaceHeader.classList.add("bottom");

                    searchHeader.classList.remove("off");
                    replaceHeader.classList.remove("off");

                    searchBtn.classList.add("button-on");
                    replaceBtn.classList.add("button-on");

                    replaceField.focus();
                    searchField.value = text;
                } else {
                    mainHeader.classList.remove("bottom");
                    searchHeader.classList.add("bottom");
                    replaceHeader.classList.remove("bottom");

                    searchHeader.classList.remove("off");
                    replaceHeader.classList.add("off");

                    searchBtn.classList.add("button-on");
                    replaceBtn.classList.remove("button-on");
                }
            }

            function extractMetadata(markdown) {
                const metaMatch = markdown.match(/«««([\s\S]*?)»»»/);
                if (!metaMatch) return {};

                const metaText = metaMatch[1];
                const metaLines = metaText.split('\n').map(line => line.trim()).filter(Boolean);

                const metadata = {};
                metaLines.forEach(line => {
                    const [key, ...rest] = line.split(':');
                    if (key && rest.length) {
                        metadata[key.trim()] = rest.join(':').trim();
                    }
                });
            
                return metadata;
            }


            async function updateMarkdown(markdown) {
                let codeBlocks = [];
                const placeholder = "￼";
                markdown = markdown.replace(/(```[\s\S]*?```|`[^`\n]+`)/g, (match) => {
                    codeBlocks.push(match);
                    return placeholder;
                });
            
                let i = 0;
                markdown = markdown.replace(/\uFFFC/g, () => codeBlocks[i++]);
            
                // refreshes metadata
                const metadata = extractMetadata(markdown);
                converter.getMetadata = function() {
                    return metadata;
                };
            
                preview.innerHTML = converter.makeHtml(markdown);

                preview.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            
                const selectors = ["img", "audio", "video", "iframe"];
                for (const tag of selectors) {
                    const elements = preview.querySelectorAll(tag);
                    for (const el of elements) {
                        const src = el.getAttribute("src");
                        if (src && src.startsWith("resources/")) {
                            const fileName = src.slice(10);
                            const dataUrl = await resolveFSItem(fileName);
                            if (dataUrl) el.src = dataUrl;
                        }
                    }
                }
            
                document.addEventListener("click", function (e) {
                    if (e.target.classList.contains("internal-link")) {
                        e.preventDefault();
                        const titleToFind = e.target.dataset.title;
                    
                        for (let i = 0; i < files.length; i++) {
                            const text = getFileText(i);
                            if (!text) continue;
                        
                            const conv = new showdown.Converter({ metadata: true });
                            conv.makeHtml(text);
                            const fileMetadata = conv.getMetadata();
                        
                            if (fileMetadata.title === titleToFind) {
                                index = i;
                                localStorage.setItem("lastIndex", index);
                                renderFiles("files");
                                renderEditor();
                                editor.focus();
                                break;
                            }
                        }
                    }
                });
            }

            function loadSettings() {
                const theme = getSetting("theme");
                if (theme) document.body.className = theme;

                const root = document.documentElement;

                const editorFont = getSetting("editorFont");
                const paragraphFont = getSetting("paragraphFont");
                const titleFont = getSetting("titleFont");

                if (editorFont) root.style.setProperty("--font-editor", editorFont);
                if (paragraphFont) root.style.setProperty("--font-text", paragraphFont);
                if (titleFont) root.style.setProperty("--font-title", titleFont);

                const metaTag = document.querySelector('meta[name="theme-color"]');
                const colorValue = getComputedStyle(document.body).getPropertyValue("--background-color-2").trim();

                if (colorValue) {
                    metaTag.setAttribute("content", colorValue);
                }

                if (getSetting("statusShow", "true") != "true") statusBar.style.display = "none";
                else statusBar.style.display = "flex";

                if (getSetting("statusCursorPos", "true") != "true") cursorPosLabel.style.display = "none";
                else cursorPosLabel.style.display = "flex";

                if (getSetting("statusEditorMode", "true") != "true") editorModeLabel.style.display = "none";
                else editorModeLabel.style.display = "flex";

                if (getSetting("statusDocumentSize", "true") != "true") documentSizeLabel.style.display = "none";
                else documentSizeLabel.style.display = "flex";

                if (getSetting("editorWidth", "false") === "true") {
                    editor.getWrapperElement().classList.add('CodeMirror-Large');
                }
            }

            function getCursor(query) {
                const cm = editor;
                const flags = caseSensitive ? "" : "i";
                let regex;

                if (useRegex) {
                    try {
                        regex = new RegExp(query, flags);
                    } catch (e) {
                        console.error("Invalid RegExp:", e);
                        return cm.getSearchCursor("");
                    }
                } else {
                    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                    regex = new RegExp(escaped, flags);
                }

                return cm.getSearchCursor(regex);
            }

            function updateCursor() {
                const query = searchField.value;
                if (query) {
                    currentCursor = getCursor(query);
                    if (currentCursor.findNext()) {
                        editor.setSelection(currentCursor.from(), currentCursor.to());
                        scrollSelection(currentCursor.from());
                        toggleSearchHeader(query, true);
                    }
                    lastQuery = query;
                }
            }

            searchField.addEventListener("keydown", function (event) {
                if (event.shiftKey && event.key === "Enter") {
                    if (!currentCursor || searchField.value !== lastQuery) updateCursor();
                    else if (currentCursor.findPrevious()) {
                        editor.setSelection(currentCursor.from(), currentCursor.to());
                        scrollSelection(currentCursor.from());
                        toggleSearchHeader(lastQuery, true);
                    }
                } else if (event.key === "Enter") {
                    if (!currentCursor || searchField.value !== lastQuery) updateCursor();
                    else if (currentCursor.findNext()) {
                        editor.setSelection(currentCursor.from(), currentCursor.to());
                        scrollSelection(currentCursor.from());
                        toggleSearchHeader(lastQuery, true);
                    }
                } else if (event.key === "Escape") {
                    toggleSearchHeader("", false);
                }
            });

            replaceField.addEventListener("keydown", function (event) {
                if (event.ctrlKey && event.key === "Enter") {
                    const cm = editor;
                    const query = searchField.value;
                    const replaceText = replaceField.value;
                    if (!query) return;

                    const cursor = getCursor(query);
                    cm.operation(() => {
                        while (cursor.findNext()) {
                            cursor.replace(replaceText);
                        }
                    });
                    toggleReplaceHeader(query, true);
                } else if (event.shiftKey && event.key === "Enter") {
                    editor.undo();
                } else if (event.key === "Enter") {
                    if (!currentCursor || searchField.value !== lastQuery) updateCursor();
                    if (currentCursor && currentCursor.from()) {
                        currentCursor.replace(replaceField.value);
                        updateCursor();
                        toggleReplaceHeader(lastQuery, true);
                    }
                } else if (event.key === "Escape") {
                    toggleSearchHeader("", false);
                }
            });

            document.getElementById("search-next-btn").onclick = () => {
                if (!currentCursor || searchField.value !== lastQuery) updateCursor();
                else if (currentCursor.findNext()) {
                    editor.setSelection(currentCursor.from(), currentCursor.to());
                    scrollSelection(currentCursor.from());
                    toggleSearchHeader(lastQuery, true);
                }
            };

            document.getElementById("search-prev-btn").onclick = () => {
                if (!currentCursor || searchField.value !== lastQuery) updateCursor();
                else if (currentCursor.findPrevious()) {
                    editor.setSelection(currentCursor.from(), currentCursor.to());
                    scrollSelection(currentCursor.from());
                    toggleSearchHeader(lastQuery, true);
                }
            };

            document.getElementById("match-case-btn").onclick = function () {
                caseSensitive = !caseSensitive;
                this.classList.toggle("button-on");
                updateCursor();
            };

            document.getElementById("regex-btn").onclick = function () {
                useRegex = !useRegex;
                this.classList.toggle("button-on");
                updateCursor();
            };

            document.getElementById("replace-one-btn").onclick = () => {
                if (!currentCursor || searchField.value !== lastQuery) updateCursor();
                if (currentCursor && currentCursor.from()) {
                    currentCursor.replace(replaceField.value);
                    updateCursor();
                    toggleReplaceHeader(lastQuery, true);
                }
            };

            document.getElementById("replace-all-btn").onclick = () => {
                const cm = editor;
                const query = searchField.value;
                const replaceText = replaceField.value;
                if (!query) return;

                const cursor = getCursor(query);
                cm.operation(() => {
                    while (cursor.findNext()) {
                        cursor.replace(replaceText);
                    }
                });
                toggleReplaceHeader(query, true);
            };

            function scrollSelection(from) {
                const line = editor.getLineHandle(from.line);
                const lineEl = editor.getLineHandleVisualStart ? editor.getLineHandleVisualStart(line).handle : line;

                const el = editor.getScrollerElement();
                const coords = editor.charCoords(from, "local");

                el.scrollTop = coords.top - 50;
            }

            async function searchDocuments() {
                const newIndex = await promptFileSearch();
                if (newIndex != null) {
                    index = newIndex;
                    renderEditor();
                    editor.focus();
                }
            }

            document.addEventListener("keydown", async function (event) {
                /** NAVIGATION **/

                //// Focus on editor (esc)
                if (event.key === "Escape") {
                    hideAllMenus();
                    closeAllDialogs();
                    editor.focus();
                    editorMenu.style.display = "none";
                    editorMenu.removeEventListener("keydown", handleArrowNavigation);
                    editorMenu.removeEventListener("keydown", handleActivation);
                }
                //// Toggle preview (ctrl p)
                else if (event.ctrlKey && event.key === "p") {
                    event.preventDefault();
                    togglePreview();
                }
                //// About cohesion (f1)
                else if (event.key === "F1") {
                    event.preventDefault();
                    showMessageFromFile("about.html");
                }
                //// Toggle sidebar (f9)
                else if (event.key === "F9") {
                    event.preventDefault();
                    toggleSidebar("files-bar");
                }
                //// Toggle main menu (f10)
                else if (event.key === "F10") {
                    event.preventDefault();
                    toggleDropdown("more-menu");
                }
                //// Toggle insert menu (ctrl i)
                else if (event.altKey && event.key === "i") {
                    event.preventDefault();
                    toggleDropdown("insert-menu");
                }
                //// Show settings screen (ctrl ,)
                else if (event.ctrlKey && event.key === ",") {
                    event.preventDefault();
                    showMessageFromFile("dialogs/settings.html", true, false, true, true, 900);
                    hideAllMenus();
                }
                //// Show shortcuts screen (ctrl ? || ctrl shift ?)
                else if (event.ctrlKey && event.key === "?") {
                    event.preventDefault();
                    showMessageFromFile("dialogs/shortcuts.html", true, false, true, true, 600);
                    hideAllMenus();
                }
                //// Show resources screen (alt p)
                else if (event.altKey && event.key === "p") {
                    event.preventDefault();
                    showMessageFromFile("dialogs/resources.html", true, true);
                    hideAllMenus();
                }
                //// Switch between the first ten documents (alt 1-0)
                else if (event.altKey && /^[0-9]$/.test(event.key)) {
                    event.preventDefault();
                    const newIndex = event.key === "0" ? 9 : parseInt(event.key) - 1;
                    if (newIndex > files.length - 1) return;
                    index = newIndex;
                    renderEditor();
                    editor.focus();
                }
                //// Search documents (ctrl e)
                else if (event.ctrlKey && event.key === "e") {
                    event.preventDefault();

                    searchDocuments();
                }

                /** FILE **/

                //// New file (ctrl n)
                else if (event.altKey && event.key === "n") {
                    event.preventDefault();
                    createFile();
                }
                //// Download file (ctrl s)
                else if (event.ctrlKey && event.key === "s") {
                    event.preventDefault();
                    promptSaveFile(index);
                }
                //// Upload file (ctrl o)
                else if (event.ctrlKey && event.key === "o") {
                    event.preventDefault();
                    importFile();
                }
                //// Delete file (ctrl shift delete)
                else if (event.shiftKey && event.ctrlKey && event.key === "Delete") {
                    event.preventDefault();
                    if (!(await promptConfirm("Delete this document?", true))) return;

                    deleteFile(index);
                    saveFilesToStorage();
                    if (files.length === 0) {
                        createFile();
                    }
                    index = files.length - 1;
                    renderFiles("files");
                    renderEditor();
                    editor.focus();
                    showToast("Deleted", "delete");
                }

                /** EDIT **/

                //// Bold (ctrl b)
                else if (event.ctrlKey && event.key === "b") {
                    event.preventDefault();
                    formatBold();
                }
                //// Italic (ctrl i)
                else if (event.ctrlKey && event.key === "i") {
                    event.preventDefault();
                    formatItalic();
                }
                //// Unordered list (ctrl u)
                else if (event.ctrlKey && event.key === "u") {
                    event.preventDefault();
                    toggleLineStart("- ", true, ["- ", "* ", "+ "]);
                }
                //// Title (ctrl 1-6)
                else if (event.ctrlKey && event.key >= "1" && event.key <= "6") {
                    event.preventDefault();
                    const level = parseInt(event.key, 10);
                    toggleLineStart(
                        "#".repeat(level) + " ",
                        true,
                        Array.from({ length: 6 }, (_, i) => "#".repeat(i + 1) + " ")
                    );
                }
                //// Link (ctrl shift k)
                else if (event.shiftKey && event.ctrlKey && event.key === "K") {
                    event.preventDefault();
                    formatUrl();
                }
                //// Horizontal rule (ctrl r)
                else if (event.ctrlKey && event.key === "r") {
                    event.preventDefault();
                    insertAt("\n\n***\n\n", 7, 7);
                }

                /** SEARCH **/

                //// Go to line (ctrl g)
                else if (event.ctrlKey && event.key === "g") {
                    event.preventDefault();
                    search();

                    async function search(warn = false) {
                        const totalLines = editor.lineCount();
                        const currentLine = editor.getCursor().line + 1;

                        const message = `Type a number between 1 and ${totalLines} to navigate to:`;
                        const lineStr = await promptString(message, currentLine, warn);
                        if (!lineStr) return;

                        const match = /^\s*(\d+)\s*$/.exec(lineStr);
                        if (match) {
                            const line = parseInt(match[1], 10) - 1;
                            if (line >= 0 && line < editor.lineCount()) {
                                editor.setCursor({ line, ch: 0 });
                                editor.focus();
                            } else {
                                showToast("Cant navigate to this line", "warning");
                                search(true);
                            }
                        } else {
                            showToast("Cant navigate to this line", "warning");
                            search(true);
                        }
                    }
                }
                //// Show search bar (ctrl f)
                else if (event.ctrlKey && event.key === "f") {
                    event.preventDefault();
                    toggleSearchHeader(editor.getSelection());
                }
                //// Show search and replace bar (ctrl h)
                else if (event.ctrlKey && event.key === "h") {
                    event.preventDefault();
                    toggleReplaceHeader(editor.getSelection());
                }

                /** INSERT **/
                
                //// Insert meta block (ctrl ;)
                else if (event.ctrlKey && event.key === ";") {
                    event.preventDefault();
                    insertAtTop(getMeta());
                }
                //// Insert date and time with custom syntax (shift f6)
                else if (event.shiftKey && event.key === "F6") {
                    event.preventDefault();
                    const strftime = await promptString("Insert date time format", getSetting("dateFormat", "%d/%m/%Y %H:%M"));
                    if (strftime){
                    insertDate(strftime);
                    }
                    editor.focus();
                }
                //// Insert date and time with default syntax (f6)
                else if(event.key === "F6") {
                    event.preventDefault();
                    insertDate();
                }
            });
        </script>
    </body>
</html>
