<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New document</title>
    <link rel="stylesheet" href="style/palette.css">
    <link rel="stylesheet" href="style/share.css">
    <link rel="stylesheet" href="style/editor.css">
    <link rel="stylesheet" href="style/prompts.css">
    <link rel="stylesheet" href="codemirror/lib/codemirror.css" />
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/markdown/markdown.js"></script>
    <script src="codemirror/addon/edit/closebrackets.js"></script>
    <script src="codemirror/addon/edit/continuelist.js"></script>
    <link rel="shortcut icon" href="resources/favicon.png" type="image/x-icon">
</head>

<body class="theme-dark">
    <header class="window-title">
        <div class="header-left">
            <button class="icon-button" translate="no" onclick="toggleSidebar('files-bar')" ondragenter="toggleSidebar('files-bar')" title="Documents">
                side_navigation
            </button>
            <button class="icon-button hide-on-mobile" translate="no" title="New file" onclick="createFile();">
                add_box
            </button>
            <hr>
            <div class="dropdown">
                <button class="icon-button" translate="no" onclick="toggleDropdown('insert-menu')" title="Insert">
                    attach_filearrow_drop_down
                </button>
                <div class="dropdown-content menu align-left" id="insert-menu">
                    <button class="text-button"
                        onclick="insertBlock(getSummary(editor.getValue())); hideAllMenus()">Summary</button>
                    <button class="text-button"
                        onclick="promptTableSelector().then((markdown) => {if (markdown) {insertBlock(markdown);}}); hideAllMenus()">Table</button>
                    <hr>
                    <button class="text-button"
                        onclick="promptIframe().then((markdown) => {if (markdown) {insertBlock(markdown);}}); hideAllMenus()">Web
                        embed</button>
                </div>
            </div>
        </div>
        <div class="header-center hide-on-tablet">
            <p id="filename">title</p>
        </div>
        <div class="header-right">
            <button class="icon-button" translate="no" title="Search">
                search
            </button>
            <button class="icon-button" translate="no" onclick="togglePreview()" title="Read" id="readbtn">
                import_contacts
            </button>
            <div class="dropdown">
                <button class="icon-button" translate="no" onclick="toggleDropdown('more-menu')" title="More options">
                    more_vert
                </button>
                <div class="dropdown-content menu" id="more-menu">
                    <button class="text-button" onclick="createFile(); hideAllMenus()">New <kbd>Ctrl+N</kbd></button>
                    <button class="text-button" onclick="importFile(); hideAllMenus()">Open <kbd>Ctrl+O</kbd></button>
                    <button class="text-button" onclick="exportFile(index); hideAllMenus()">Save
                        <kbd>Ctrl+S</kbd></button>
                    <hr>
                    <button class="text-button"
                        onclick="promptMessageFromFile('settings.html'); hideAllMenus()">Settings
                        <kbd>Ctrl+,</kbd></button>
                    <hr>
                    <button class="text-button"
                        onclick="window.open('read.html?path=tutorial.md'); hideAllMenus()">Tutorial</button>
                    <button class="text-button">Keyboard shortcuts <kbd>Ctrl+?</kbd></button>
                    <button class="text-button" onclick="promptMessageFromFile('about.html'); hideAllMenus();">About
                        Cohesion <kbd>F1</kbd></button>
                    <hr>
                    <button class="text-button" onclick="deleteEmptyFiles(); hideAllMenus()">Clear empty files</button>
                </div>
            </div>
        </div>
    </header>

    <div id="files-bar" class="sidebar">
        <button class="text-button hide-on-pc" style="width: 100%; margin-top: 20px; margin-bottom: 20px;"
            onclick="createFile();">Create new document</button>
        <div id="files"></div>
    </div>

    <div class="main-wrapper">
        <textarea id="editor"></textarea>
        <div id="preview" class="preview"></div>
    </div>

    <script src="script/showdown.js"></script>
    <script src="script/edittools.js"></script>
    <script src="script/insert.js"></script>
    <script src="script/menus.js"></script>
    <script src="script/file.js"></script>
    <script src="script/settings.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script>
        loadFilesFromStorage();

        let index = 0;

        const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
            mode: "markdown",
            lineNumbers: false,
            theme: "default",
            lineWrapping: true,
            autoCloseBrackets: true,
            extraKeys: {
                "Enter": "newlineAndIndentContinueMarkdownList"
            }
        });

        const converter = new showdown.Converter();
        const preview = document.getElementById("preview");

        function renderEditor() {
            if (!files[index]) files[index] = "";
            editor.setValue(files[index]);
            document.getElementById("filename").innerText = getFileTitle(index) || "New document";
            document.title = getFileTitle(index) || "New document";
        }

        if (files.length == 0) createFile();
        renderEditor();
        renderFiles("files");
        editor.focus();
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
        });

        editor.on("change", instance => {
            updateFile(instance.getValue(), index);
            saveFilesToStorage();
            renderFiles("files");
            document.getElementById("filename").innerText = getFileTitle(index) || "New document";
            if (preview.classList.contains("on")) updateMarkdown(instance.getValue());
        });

        function togglePreview() {
            const isOn = preview.classList.contains('on');
            const readBtn = document.getElementById('readbtn');

            if (isOn) {
                preview.classList.remove('on');
                editor.getWrapperElement().style.display = "block";
                editor.focus();
                readBtn.innerText = "import_contacts";
                readBtn.title = "Read";
                readBtn.classList.remove("button-on");
            } else {
                updateMarkdown(editor.getValue());

                const cursorLine = editor.getCursor().line;
                const totalLines = editor.lineCount();
                const scrollRatio = cursorLine / totalLines;

                preview.classList.add('on');
                editor.getWrapperElement().style.display = "none";
                readBtn.innerText = "edit";
                readBtn.title = "Write";
                readBtn.classList.add("button-on");

                requestAnimationFrame(() => {
                    preview.scrollTop = scrollRatio * (preview.scrollHeight - preview.clientHeight);
                });

                // document.querySelectorAll("#preview a").forEach(link => {
                //     const href = link.getAttribute("href") || "";
                //     if (!href.startsWith("http") || href.startsWith("http:")) return;
                //     const url = new URL(href);
                //     const img = document.createElement("img");
                //     img.className = "favicon";
                //     img.alt = "Favicon";
                //     img.src = `https://www.google.com/s2/favicons?sz=64&domain_url=${url.origin}`;
                //     link.prepend(img);
                // });
            }
        }

        function updateMarkdown(markdown) {
            let codeBlocks = [];
            const placeholder = "ï¿¼";
            markdown = markdown.replace(/(```[\s\S]*?```|`[^`\n]+`)/g, match => {
                codeBlocks.push(match);
                return placeholder;
            });
            let i = 0;
            markdown = markdown.replace(/\uFFFC/g, () => codeBlocks[i++]);
            preview.innerHTML = converter.makeHtml(markdown);
        }

        function getSummary(markdown) {
            const lines = markdown.split('\n');
            const titles = [];

            for (const line of lines) {
                const match = line.match(/^(#{1,6})\s+(.+)$/);
                if (match) {
                    const level = match[1].length;
                    const text = match[2].trim();
                    const id = text
                        .toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-');

                    titles.push({ level, text, id });
                }
            }

            return titles.map(title => {
                const indent = '    '.repeat(title.level - 1);
                return `${indent}- [${title.text}](#${title.id})`;
            }).join('\n');
        }

        function loadSettings() {
            const theme = getSetting('theme');
            if (theme) document.body.className = theme;

            const root = document.documentElement;

            const editorFont = getSetting('editorFont');
            const paragraphFont = getSetting('paragraphFont');
            const titleFont = getSetting('titleFont');

            if (editorFont) {
                root.style.setProperty('--font-editor', editorFont);
            }

            if (paragraphFont) {
                root.style.setProperty('--font-text', paragraphFont);
            }

            if (titleFont) {
                root.style.setProperty('--font-title', titleFont);
            }
        }

        document.addEventListener("keydown", async function (event) {
            // NAVIGATION
            if (event.ctrlKey && event.key === "p") { // toggle preview - ctrl+p
                event.preventDefault();
                togglePreview();
            }

            else if (event.key === "F1") { // about - f1
                event.preventDefault();
                promptMessageFromFile('about.html');
            }

            else if (event.key === "F9") { // toggle sidepane - f9
                event.preventDefault();
                toggleSidebar('files-bar');
            }

            else if (event.ctrlKey && event.key === ',') {
                promptMessageFromFile('settings.html');
                hideAllMenus();
            }

            // FILE
            else if (event.ctrlKey && event.key === "n") { // new - ctrl+n
                event.preventDefault();
                createFile();
            }

            else if (event.ctrlKey && event.key === "s") { // download - ctrl+s
                event.preventDefault();
                exportFile(index);
            }

            else if (event.ctrlKey && event.key === "o") { // open - ctrl+o
                event.preventDefault();
                importFile();
            }

            else if (event.ctrlKey && event.key === "Delete") { // delete - ctrl+delete
                event.preventDefault();
                if (! await promptConfirm("Delete this document?")) return;

                deleteFile(index);
                saveFilesToStorage();
                if (files.length === 0) {
                    createFile();
                }
                index = files.length - 1;
                renderFiles("files");
                renderEditor();
                editor.focus();
                showToast('Deleted', 'delete')
            }

            // EDIT
            else if (event.ctrlKey && event.key === "b") { // bold - ctrl+b
                event.preventDefault();
                if (hasSelection()) {
                    wrapSelection("**", "**");
                } else {
                    insertAt("**Bold text**", 2, 11)
                }
            }

            else if (event.ctrlKey && event.key === "i") { // italic - ctrl+i
                event.preventDefault();
                if (hasSelection()) {
                    wrapSelection("*", "*");
                } else {
                    insertAt("*Italic text*", 1, 12)
                }
            }

            else if (event.ctrlKey && event.key === "u") { // unordered list - ctrl+u
                event.preventDefault();
                toggleLineStart("- ", true, ["- ", "* ", "+ "]);
            }

            else if (event.ctrlKey && event.key >= "1" && event.key <= "6") { // titles - ctrl+1/6
                event.preventDefault();
                const level = parseInt(event.key, 10);
                toggleLineStart("#".repeat(level) + " ", true, Array.from({ length: 6 }, (_, i) => "#".repeat(i + 1) + " "));
            }

            else if (event.ctrlKey && event.key === "r") { // horizontal rule - ctrl+r
                event.preventDefault();
                insertAt("\n\n***\n\n", 7, 7)
            }
        });
    </script>
</body>

</html>